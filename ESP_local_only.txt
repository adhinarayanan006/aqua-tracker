/*
 * OPTION A: LOCAL WEB SERVER
 * * Logic:
 * 1. Connects to Home Wi-Fi.
 * 2. Reads Ultrasonic Sensor.
 * 3. Hosts a simple HTML webpage with a gauge.
 * 4. Refreshes the page every 3 seconds automatically.
 */

#include <WiFi.h>
#include <WebServer.h>

// --- USER CONFIGURATION ---
const char* ssid = "YOUR_WIFI_NAME";
const char* password = "YOUR_WIFI_PASSWORD";

// Tank Dimensions (Calibrate these)
const float TANK_HEIGHT_CM = 100.0; 
const float SENSOR_GAP_CM = 20.0;   

// Pins
#define TRIG_PIN 5
#define ECHO_PIN 18

// --- SERVER OBJECT ---
WebServer server(80);

// Global variable to hold current level
int currentLevel = 0;

// Function to measure distance
float getDistance() {
  digitalWrite(TRIG_PIN, LOW);
  delayMicroseconds(2);
  digitalWrite(TRIG_PIN, HIGH);
  delayMicroseconds(10);
  digitalWrite(TRIG_PIN, LOW);
  
  long duration = pulseIn(ECHO_PIN, HIGH);
  float distance = duration * 0.034 / 2;
  return distance;
}

// Function to generate HTML
String getHTML() {
  String html = "<!DOCTYPE html><html><head>";
  html += "<meta name='viewport' content='width=device-width, initial-scale=1'>";
  // Refresh page every 3 seconds
  html += "<meta http-equiv='refresh' content='3'>"; 
  html += "<style>";
  html += "body { font-family: sans-serif; text-align: center; background: #f0f2f5; margin: 0; padding: 20px; }";
  html += ".card { background: white; max-width: 400px; margin: auto; padding: 20px; border-radius: 15px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }";
  html += ".gauge { width: 100%; height: 30px; background: #ddd; border-radius: 15px; margin: 20px 0; overflow: hidden; }";
  // Dynamic CSS for bar width
  html += ".fill { height: 100%; width: " + String(currentLevel) + "%; background: " + (currentLevel < 20 ? "#ff4d4d" : "#00cc66") + "; transition: width 0.5s; }";
  html += "h1 { color: #333; }";
  html += ".value { font-size: 50px; font-weight: bold; color: #333; }";
  html += "</style></head><body>";
  
  html += "<div class='card'>";
  html += "<h1>Water Level</h1>";
  html += "<div class='value'>" + String(currentLevel) + "%</div>";
  html += "<div class='gauge'><div class='fill'></div></div>";
  html += "<p>Status: " + String(currentLevel < 20 ? "Low Warning!" : "Normal") + "</p>";
  html += "</div>";
  
  html += "</body></html>";
  return html;
}

void handleRoot() {
  server.send(200, "text/html", getHTML());
}

void setup() {
  Serial.begin(115200);
  pinMode(TRIG_PIN, OUTPUT);
  pinMode(ECHO_PIN, INPUT);

  // Connect to Wi-Fi
  WiFi.begin(ssid, password);
  Serial.print("Connecting");
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  
  Serial.println("");
  Serial.print("Connected! IP Address: ");
  Serial.println(WiFi.localIP());

  // Start Server
  server.on("/", handleRoot);
  server.begin();
  Serial.println("HTTP server started");
}

void loop() {
  server.handleClient();
  
  // Update reading
  float dist = getDistance();
  
  // Calculate %
  float maxWater = TANK_HEIGHT_CM - SENSOR_GAP_CM;
  float currentWater = TANK_HEIGHT_CM - dist;
  int pct = (currentWater / maxWater) * 100;
  
  // Clamp
  if (pct < 0) pct = 0;
  if (pct > 100) pct = 100;
  
  currentLevel = pct;
  delay(100); // Small delay
}