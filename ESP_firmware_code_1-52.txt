/*
 * AQUA TRACK FIRMWARE v1.0
 * Device: ESP32 + JSN-SR04T (Waterproof)
 * Cloud: Google Firestore
 * * LIBRARIES REQUIRED (Install via Library Manager):
 * 1. "Firebase Arduino Client" by Mobizt
 */

#include <WiFi.h>
#include <Firebase_ESP_Client.h>

// Provide the token generation process info.
#include "addons/TokenHelper.h"
// Provide the RTDB payload printing info and other helper functions.
#include "addons/RTDBHelper.h"

// ==========================================
// 1. USER CONFIGURATION
// ==========================================

// Wi-Fi Credentials
#define WIFI_SSID "YOUR_WIFI_NAME"
#define WIFI_PASSWORD "YOUR_WIFI_PASSWORD"

// Firebase Settings (From Project Settings)
#define API_KEY "YOUR_API_KEY_HERE"
#define FIREBASE_PROJECT_ID "YOUR_PROJECT_ID" // e.g. aqua-track-123

// Tank Dimensions (Measure these on your real tank!)
#define TANK_HEIGHT_CM 100.0  // Distance from Sensor to Bottom of Tank
#define SENSOR_GAP_CM 20.0    // Distance from Sensor to "Full" Water Line (Blind zone)

// ==========================================

// Pins (JSN-SR04T)
#define TRIG_PIN 5
#define ECHO_PIN 18

// Objects
FirebaseData fbdo;
FirebaseAuth auth;
FirebaseConfig config;

bool signupOK = false;
unsigned long sendDataPrevMillis = 0;

void setup() {
  Serial.begin(115200);
  
  pinMode(TRIG_PIN, OUTPUT);
  pinMode(ECHO_PIN, INPUT);

  // 1. Connect to Wi-Fi
  WiFi.begin(WIFI_SSID, WIFI_PASSWORD);
  Serial.print("Connecting to Wi-Fi");
  while (WiFi.status() != WL_CONNECTED) {
    Serial.print(".");
    delay(300);
  }
  Serial.println();
  Serial.println("Connected to Wi-Fi");

  // 2. Configure Firebase
  config.api_key = API_KEY;
  config.service_account.json.project_id = FIREBASE_PROJECT_ID;

  // Sign up anonymously
  if (Firebase.signUp(&config, &auth, "", "")){
    Serial.println("Firebase Auth Success");
    signupOK = true;
  } else {
    Serial.printf("Auth Failed: %s\n", config.signer.signupError.message.c_str());
  }

  Firebase.begin(&config, &auth);
  Firebase.reconnectWiFi(true);
}

// Function to read clean distance
float getDistance() {
  // Clear trigger
  digitalWrite(TRIG_PIN, LOW);
  delayMicroseconds(2);
  // Send pulse
  digitalWrite(TRIG_PIN, HIGH);
  delayMicroseconds(10);
  digitalWrite(TRIG_PIN, LOW);
  
  // Read Echo
  long duration = pulseIn(ECHO_PIN, HIGH);
  
  // Calculate distance
  // Speed of sound = 343m/s = 0.0343 cm/us
  float dist = duration * 0.0343 / 2;
  return dist;
}

void loop() {
  // 1. Get Distance
  float rawDist = getDistance();

  // 2. Filter & Limit Data
  // (JSN-SR04T sometimes returns 0 if signal is lost, ignore those)
  if (rawDist > 0 && rawDist < 400) {
    
    // 3. Calculate Percentage
    // Formula: % = (TotalDepth - CurrentDistance) / (TotalDepth - BlindZone)
    float waterHeight = TANK_HEIGHT_CM - rawDist;
    float usableHeight = TANK_HEIGHT_CM - SENSOR_GAP_CM;
    
    int percentage = (waterHeight / usableHeight) * 100;
    
    // Clamp to 0-100
    if (percentage < 0) percentage = 0;
    if (percentage > 100) percentage = 100;

    Serial.print("Distance: "); Serial.print(rawDist);
    Serial.print("cm | Level: "); Serial.print(percentage); Serial.println("%");

    // 4. Send to Cloud (Every 2 Seconds)
    if (Firebase.ready() && signupOK && (millis() - sendDataPrevMillis > 2000)) {
      sendDataPrevMillis = millis();

      // Define the path exactly as the React App expects it
      String documentPath = "water_monitor/current_status";

      // Create JSON payload
      FirebaseJson content;
      content.set("fields/level/integerValue", percentage);
      
      // Add a timestamp field (optional, helps with debugging)
      // content.set("fields/updated/timestampValue", "REQUEST_TIME_STAMP");

      Serial.print("Uploading... ");
      
      // Write to Firestore
      if (Firebase.Firestore.patchDocument(&fbdo, FIREBASE_PROJECT_ID, "", documentPath.c_str(), content.raw(), "level")) {
          Serial.println("Success!");
      } else {
          Serial.print("Failed: ");
          Serial.println(fbdo.errorReason());
      }
    }
  } else {
    Serial.println("Sensor Error or Out of Range");
  }
  
  delay(100); // Short delay between loop cycles
}
